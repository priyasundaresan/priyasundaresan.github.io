<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sleepy Grad Student Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      margin:0; 
      background:#fff; 
      text-align:center; 
      font-family:'Libre Franklin', sans-serif; 
    }
    canvas { 
      background:#fff; 
      display:block; 
      margin:20px auto; 
      border:3px solid #444; 
      border-radius:10px; 
      width:400px;
      height:500px;
    }
    #score, #lives { font-size:20px; margin-top:5px; }
    #lives { color:red; }
    #menu { margin-top: 15px; }
    button {
      font-family:'Libre Franklin', sans-serif;
      font-size:16px;
      padding:8px 14px;
      margin: 5px;
      border-radius:8px;
      border:2px solid #444;
      background:#f8f8f8;
      cursor:pointer;
    }
    button:hover { background:#e0e0e0; }
  </style>
</head>
<body>
  <h2>Sleepy Grad Student</h2>
  <canvas id="gameCanvas" width="400" height="500"></canvas>
  <div id="score">HP: 5</div>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <div id="menu">
    <button id="playBtn">Play</button>
    <button id="rulesBtn">Rules Refresh</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // --- High DPI scaling ---
    function resizeCanvasForHighDPI(canvas, ctx) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
    }
    resizeCanvasForHighDPI(canvas, ctx);

    let grad = { x: 200, y: 450, size: 40, hp: 5, face: "üò¥", faceTimer: 0 };
    let cursor = { x: 200, y: 480 };
    let items = [];
    let floatTexts = [];
    let frame = 0;
    let gameOver = false;
    let gameWon = false;
    let lives = 3;
    let stunned = 0;

    let state = "menu"; // menu, intro, demo, countdown, playing
    let stateTimer = 0;
    let firstTime = !localStorage.getItem("gradGamePlayed");

    let floodTimer = 0;
    let showMessage = false;

    if (firstTime) {
      state = "intro";
      localStorage.setItem("gradGamePlayed", "true");
      document.getElementById("menu").style.display = "none";
    }

    canvas.addEventListener("mousemove", e => {
      if (state !== "playing") return;
      const rect = canvas.getBoundingClientRect();
      grad.x = e.clientX - rect.left;
    });

    document.getElementById("playBtn").onclick = () => {
      resetGame();
      state = "playing";
      document.getElementById("menu").style.display = "block";
    };

    document.getElementById("rulesBtn").onclick = () => {
      resetGame();
      state = "intro";
      stateTimer = 0;
      items = [];
      document.getElementById("menu").style.display = "none";
    };

    function resetGame() {
      grad = { x: 200, y: 450, size: 40, hp: 5, face: "üò¥", faceTimer: 0 };
      cursor = { x: 200, y: 480 };
      items = [];
      floatTexts = [];
      frame = 0;
      gameOver = false;
      gameWon = false;
      lives = 3;
      stunned = 0;
      floodTimer = 0;
      showMessage = false;
      updateLivesDisplay();
      document.getElementById("score").textContent = "HP: 5";
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function spawnItem() {
      let paperChance = (state === "demo") ? 0.4 : Math.min(0.3 + grad.hp * 0.005, 0.7);
      const good = Math.random() > paperChance;
      items.push({
        x: Math.random() * (400 - 30) + 15,
        y: -20,
        size: 30,
        good: good,
        emoji: good ? (Math.random() < 0.5 ? "üçï" : "‚òï") : "üìÑ"
      });
    }

    function drawText(text, x, y, size, color="black", align="center") {
      ctx.font = `${size}px 'Libre Franklin', sans-serif`;
      ctx.fillStyle = color;
      ctx.textAlign = align;
      ctx.textBaseline = "middle";
      ctx.fillText(text, x, y);
    }

    function drawGrad() {
      drawText(grad.face, grad.x, grad.y, 40, "black", "center");
      if (grad.faceTimer > 0) grad.faceTimer--;
      else if (grad.face !== "üòµ‚Äçüí´") grad.face = "üò¥";
    }

    function drawCursor() { drawText("üñ±Ô∏è", cursor.x, cursor.y, 24, "black", "center"); }
    function drawItems() { items.forEach(it => drawText(it.emoji, it.x, it.y, it.size, "black", "center")); }
    function updateItems(speed) { items.forEach(it => { it.y += speed; }); items = items.filter(it => it.y < 540); }

    function checkCollisions() {
      items.forEach((it, i) => {
        if (Math.abs(it.x - grad.x) < 30 && Math.abs(it.y - grad.y) < 30) {
          if (state === "playing") {
            if (it.good) {
              grad.hp++;
              grad.face = "üò≥"; grad.faceTimer = 20;
              floatTexts.push({ text: "+1", x: grad.x, y: grad.y, color: "green", life: 30 });
            } else {
              grad.hp--; lives--; grad.face = "üòµ‚Äçüí´"; stunned = 60;
              floatTexts.push({ text: "-1", x: grad.x, y: grad.y, color: "red", life: 30 });
              updateLivesDisplay();
              if (lives <= 0) gameOver = true;
            }
          } else {
            grad.face = it.good ? "üò≥" : "üòµ‚Äçüí´";
            floatTexts.push({ text: it.good ? "+1" : "ouch!", x: grad.x, y: grad.y, color: it.good ? "green" : "red", life: 30 });
          }
          items.splice(i, 1);
        }
      });
    }

    function drawFloatTexts() {
      floatTexts.forEach(ft => { drawText(ft.text, ft.x, ft.y, 20, ft.color, "center"); ft.y -= 1; ft.life--; });
      floatTexts = floatTexts.filter(ft => ft.life > 0);
    }

    function updateLivesDisplay() { document.getElementById("lives").textContent = "‚ù§Ô∏è".repeat(lives); }

    function loop() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (state === "menu") {
        drawText("welcome back!", 200, 200, 24, "black");
        drawText("choose play or rules refresh below.", 200, 240, 16, "gray");
      } 
      else if (state === "intro") {
        let secondsLeft = 5 - Math.floor(stateTimer / 60);
        drawText("POV: your deadline is AOE tonight", 200, 120, 18, "black");
        drawText("but you forgot to eat all day...", 200, 150, 18, "black");
        drawText("collect the üçï‚òï", 200, 240, 20, "green");
        drawText("take a break from ur paper (üìÑ).", 200, 270, 20, "red");
        drawText("game starts in " + secondsLeft, 200, 340, 20, "black");

        stateTimer++;
        if (stateTimer > 300) { state = "demo"; stateTimer = 0; items = []; }
      } 
      else if (state === "demo") {
        grad.x = 200 + Math.sin(frame / 50) * 120;
        cursor.x = grad.x;
        if (frame % 40 === 0) spawnItem();

        updateItems(3); drawGrad(); drawCursor(); drawItems(); checkCollisions(); drawFloatTexts();

        let secondsLeft = 8 - Math.floor(stateTimer / 60);
        drawText("Demo... watch the cursor!", 200, 80, 20, "blue");
        drawText("next in " + secondsLeft, 200, 110, 18, "gray");

        stateTimer++;
        if (stateTimer > 480) { state = "countdown"; stateTimer = 180; }
      } 
      else if (state === "countdown") {
        let secondsLeft = Math.ceil(stateTimer / 60);
        drawText("Ready to play?", 200, 200, 24, "black");
        drawText(secondsLeft, 200, 260, 40, "red");
        stateTimer--;
        if (stateTimer <= 0) { state = "playing"; document.getElementById("menu").style.display = "block"; }
      } 
      else if (state === "playing") {
        if (gameOver || gameWon) {
          if (!showMessage && gameOver) {
            if (floodTimer < 120) {
              for (let i=0;i<10;i++) items.push({ x: Math.random()*400, y: -20, size: 30+Math.random()*10, good:false, emoji:"üìÑ" });
              updateItems(8); drawItems(); drawGrad(); drawFloatTexts(); floodTimer++; frame++; requestAnimationFrame(loop); return;
            } else { items = []; showMessage = true; }
          }
          ctx.clearRect(0,0,canvas.width,canvas.height);
          drawText("break's over back to the grindüìÑüíÄ", 200, 250, 18, "red");
          drawGrad(); drawFloatTexts(); frame++; requestAnimationFrame(loop); return;
        }

        let speed = Math.min(grad.hp * 0.03 + frame/600, 2.5); 
        let spawnRate = Math.max(60 - grad.hp * 0.2 - frame/200, 2);

        drawGrad(); drawItems();
        if (stunned > 0) stunned--; else { updateItems(speed); checkCollisions(); }
        drawFloatTexts(); document.getElementById("score").textContent = "HP: " + grad.hp;
        if (grad.hp >= 100) gameWon = true;
        if (frame % Math.floor(spawnRate) === 0) spawnItem();
      }

      frame++; requestAnimationFrame(loop);
    }

    updateLivesDisplay(); loop();
  </script>
</body>
</html>

